<!DOCTYPE html>
<html>
<head>
    <title>测试 Generate Insight 函数</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        #response {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        select {
            padding: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>测试 Generate Insight 函数</h1>
    
    <div>
        <p>选择要分析的视图：</p>
        <select id="viewSelector">
            <option value="view_ga4_summary">Google Analytics 4 概览</option>
            <option value="view_gsc_summary">Google Search Console 概览</option>
            <option value="view_wc_summary">WooCommerce 概览</option>
            <option value="view_combined_summary">综合数据概览</option>
        </select>
    </div>
    
    <button onclick="callFunction()">生成洞察</button>
    
    <h2>响应：</h2>
    <div id="response">等待调用...</div>

    <script>
        async function callFunction() {
            const viewName = document.getElementById('viewSelector').value;
            document.getElementById('response').textContent = '正在调用函数，请稍候...';
            
            try {
                const response = await fetch('https://rrfurkgzyliqudkjmckk.supabase.co/functions/v1/generate-insight', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ viewName }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let result = '';
                
                // 读取并显示流式响应
                document.getElementById('response').textContent = '接收数据中:\n';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    console.log('接收到的数据块:', chunk);
                    
                    try {
                        // 处理流式事件数据
                        const lines = chunk.split('\n');
                        
                        lines.forEach(line => {
                            if (line.startsWith('data:')) {
                                try {
                                    // 移除前缀 "data: "
                                    const jsonStr = line.substring(5).trim();
                                    if (jsonStr) {
                                        const data = JSON.parse(jsonStr);
                                        if (data.candidates && 
                                            data.candidates[0] && 
                                            data.candidates[0].content && 
                                            data.candidates[0].content.parts) {
                                                
                                            const text = data.candidates[0].content.parts[0].text || '';
                                            result += text;
                                            document.getElementById('response').textContent = result;
                                        }
                                    }
                                } catch (e) {
                                    console.error('解析事件数据时出错:', e, line);
                                }
                            }
                        });
                    } catch (e) {
                        console.error('处理流数据时出错:', e);
                    }
                }
                
                // 尝试解析为JSON（如果是JSON响应）
                try {
                    const parsedResult = JSON.parse(result);
                    document.getElementById('response').textContent = JSON.stringify(parsedResult, null, 2);
                } catch (e) {
                    // 如果不是有效的JSON，则以纯文本形式显示
                    console.log('非JSON响应，以文本形式显示');
                }
            } catch (error) {
                document.getElementById('response').textContent = `调用出错: ${error.message}`;
                console.error('调用错误:', error);
            }
        }
    </script>
</body>
</html> 